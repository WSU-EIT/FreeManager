@* FreeCICD Pipeline Wizard Component *@
@* This component contains all FreeCICD-specific UI logic *@
@* It is referenced from Index.App.razor to keep base files clean for upgrades *@

@implements IDisposable
@using Humanizer
@inject BlazorDataModel Model

@code {
    protected bool _loadedData = false;
    protected bool _loading = true;
    protected string _pageName = "home";

    public void Dispose()
    {
        Model.OnChange -= OnDataModelUpdated;
    }

    protected override void OnInitialized()
    {
        Model.OnChange += OnDataModelUpdated;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Model.Loaded && Model.LoggedIn) {
            if (!_loadedData) {
                _loadedData = true;
                await LoadData();
            }
        }
    }

    protected void OnDataModelUpdated()
    {
        if (Model.View == _pageName) {
            StateHasChanged();
        }
    }

    protected async Task LoadData()
    {
        await MyLoadDataAsync();
        _loading = false;
        StateHasChanged();
    }

    protected string LogoUrl {
        get {
            if (Model.Tenant.TenantSettings.Logo.HasValue && Model.Tenant.TenantSettings.Logo != Guid.Empty) {
                return Model.ApplicationUrl + "File/View/" + ((Guid)Model.Tenant.TenantSettings.Logo).ToString();
            } else {
                return String.Empty;
            }
        }
    }
}

@if (Model.Loaded && Model.LoggedIn && Model.View == _pageName) {
    if (Model.Tenant.TenantSettings.LogoIncludedOnHomePage && !String.IsNullOrWhiteSpace(LogoUrl)) {
        <div class="home-page-logo-container">
            <img src="@LogoUrl" class="logo-homepage" />
        </div>
    }

    if (_loading) {
        <LoadingMessage />
    } else {
        <h1 class="page-title">
            @if (!String.IsNullOrWhiteSpace(Model.Tenant.TenantSettings.AppIcon)) {
                <i>@((MarkupString)Model.Tenant.TenantSettings.AppIcon)</i>
            }
            <Language Tag="Welcome" ReplaceSpaces="true" /> @Model.User.FirstName
        </h1>

        if (Model.Loaded && Model.View == "home") {
            @* Layout 4: Card-Based Stepper with Inline Summary - Bootstrap Only *@
            <div class="container-fluid px-0" style="max-width: 1000px;">
                @* Wizard Stepper - Horizontal step indicator *@
                <WizardStepper Steps="@GetWizardSteps()" 
                               CurrentStep="@GetAdjustedCurrentStep()" 
                               OnStepClick="@(async (step) => await GoToStep(step + (_hidePAT ? 1 : 0)))" />

                @* Selection Summary - Shows previous selections inline *@
                @if (currentStep > (_hidePAT ? 1 : 0))
                {
                    <SelectionSummary Selections="@GetSelectionSummary()" />
                }

                @* Main Wizard Card *@
                <div class="card shadow-sm border-0">
                    @{
                        switch (StepNames[currentStep]) {
                            case DataObjects.StepNameList.SelectPAT:
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary">Step @(currentStep + 1)</span>
                                        <span class="fw-semibold">Azure DevOps Credentials</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary btn-sm"
                                                @onclick="PATandOrgNameChangedWizard"
                                                disabled="@(_loading || string.IsNullOrWhiteSpace(DevOpsPAT) || string.IsNullOrWhiteSpace(OrgName))">
                                            Next
                                            <i class="fa fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                                break;

                            case DataObjects.StepNameList.SelectProject:
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary">Step @(currentStep + 1 - (_hidePAT ? 1 : 0))</span>
                                        <span class="fw-semibold">Select Project</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        @if (currentStep > (_hidePAT ? 1 : 0))
                                        {
                                            <button class="btn btn-outline-light btn-sm" @onclick="StartOver" disabled="@(_loading)">
                                                <i class="fa fa-refresh me-1"></i>
                                                Start Over
                                            </button>
                                        }
                                        <button class="btn btn-primary btn-sm" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectProject)" disabled="@(_loading || string.IsNullOrEmpty(SelectedProjectId))">
                                            Next
                                            <i class="fa fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                                break;

                            case DataObjects.StepNameList.SelectRepository:
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary">Step @(currentStep + 1 - (_hidePAT ? 1 : 0))</span>
                                        <span class="fw-semibold">Select Repository</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" @onclick="StartOver" disabled="@(_loading)">
                                            <i class="fa fa-refresh me-1"></i>
                                            Start Over
                                        </button>
                                        <button class="btn btn-secondary btn-sm" @onclick="PrevStep" disabled="@(_loading)">
                                            <i class="fa fa-arrow-left me-1"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectRepository)" disabled="@(_loading || string.IsNullOrEmpty(SelectedRepoId))">
                                            Next
                                            <i class="fa fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                                break;

                            case DataObjects.StepNameList.SelectBranch:
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary">Step @(currentStep + 1 - (_hidePAT ? 1 : 0))</span>
                                        <span class="fw-semibold">Select Branch</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" @onclick="StartOver" disabled="@(_loading)">
                                            <i class="fa fa-refresh me-1"></i>
                                            Start Over
                                        </button>
                                        <button class="btn btn-secondary btn-sm" @onclick="PrevStep" disabled="@(_loading)">
                                            <i class="fa fa-arrow-left me-1"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectBranch)" disabled="@(_loading || string.IsNullOrEmpty(SelectedBranch))">
                                            Next
                                            <i class="fa fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                                break;

                            case DataObjects.StepNameList.SelectCsprojFile:
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary">Step @(currentStep + 1 - (_hidePAT ? 1 : 0))</span>
                                        <span class="fw-semibold">Select .csproj File</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" @onclick="StartOver" disabled="@(_loading)">
                                            <i class="fa fa-refresh me-1"></i>
                                            Start Over
                                        </button>
                                        <button class="btn btn-secondary btn-sm" @onclick="PrevStep" disabled="@(_loading)">
                                            <i class="fa fa-arrow-left me-1"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectCsprojFile)" disabled="@(_loading)">
                                            Next
                                            <i class="fa fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                                break;

                            case DataObjects.StepNameList.EnvironmentSettings:
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary">Step @(currentStep + 1 - (_hidePAT ? 1 : 0))</span>
                                        <span class="fw-semibold">Environment Settings</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" @onclick="StartOver" disabled="@(_loading)">
                                            <i class="fa fa-refresh me-1"></i>
                                            Start Over
                                        </button>
                                        <button class="btn btn-secondary btn-sm" @onclick="PrevStep" disabled="@(_loading)">
                                            <i class="fa fa-arrow-left me-1"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" @onclick="(e) => NextStep(DataObjects.StepNameList.EnvironmentSettings)" disabled="@(_loading)">
                                            Next
                                            <i class="fa fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                                break;

                            case DataObjects.StepNameList.SelectPipelineSelection:
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary">Step @(currentStep + 1 - (_hidePAT ? 1 : 0))</span>
                                        <span class="fw-semibold">Pipeline Selection</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" @onclick="StartOver" disabled="@(_loading)">
                                            <i class="fa fa-refresh me-1"></i>
                                            Start Over
                                        </button>
                                        <button class="btn btn-secondary btn-sm" @onclick="PrevStep" disabled="@(_loading)">
                                            <i class="fa fa-arrow-left me-1"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectPipelineSelection)" disabled="@(_loading || (SelectedPipelineId <= 0 && string.IsNullOrWhiteSpace(NewPipelineName)))">
                                            Next
                                            <i class="fa fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                                break;

                            case DataObjects.StepNameList.YAMLPreviewAndSave:
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary">Step @(currentStep + 1 - (_hidePAT ? 1 : 0))</span>
                                        <span class="fw-semibold">YAML Preview & Save</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" @onclick="StartOver" disabled="@(_loading || _isPreviewLoading || _isSaving)">
                                            <i class="fa fa-refresh me-1"></i>
                                            Start Over
                                        </button>
                                        <button class="btn btn-secondary btn-sm" @onclick="PrevStep" disabled="@(_loading || _isPreviewLoading || _isSaving)">
                                            <i class="fa fa-arrow-left me-1"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-success btn-sm" @onclick="(e) => NextStep(DataObjects.StepNameList.YAMLPreviewAndSave)" disabled="@(_loading || _isPreviewLoading || _isSaving)">
                                            <i class="fa fa-save me-1"></i>
                                            Save YAML & Pipeline
                                        </button>
                                    </div>
                                </div>
                                break;

                            case DataObjects.StepNameList.Completed:
                                @* Header changes based on save state *@
                                @if (_isSaving)
                                {
                                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Saving...</span>
                                            </div>
                                            <span class="fw-semibold">Saving Pipeline...</span>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <span class="text-muted small">Please don't navigate away</span>
                                        </div>
                                    </div>
                                }
                                else if (!string.IsNullOrWhiteSpace(_saveErrorMessage))
                                {
                                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-light text-danger"><i class="fa fa-times"></i></span>
                                            <span class="fw-semibold">Save Failed</span>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-light btn-sm" @onclick="PrevStep">
                                                <i class="fa fa-arrow-left me-1"></i>
                                                Back to Preview
                                            </button>
                                            <button class="btn btn-outline-light btn-sm" @onclick="StartOver">
                                                <i class="fa fa-refresh me-1"></i>
                                                Start Over
                                            </button>
                                        </div>
                                    </div>
                                }
                                else if (_saveCompleted)
                                {
                                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-light text-success"><i class="fa fa-check"></i></span>
                                            <span class="fw-semibold">Completed</span>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-light btn-sm" @onclick="StartOver">
                                                <i class="fa fa-refresh me-1"></i>
                                                Create Another Pipeline
                                            </button>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    @* Fallback - shouldn't normally reach here *@
                                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center flex-wrap gap-2 py-3">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="fw-semibold">Processing...</span>
                                        </div>
                                    </div>
                                }
                                break;
                        }
                    }

                    <div class="card-body p-4">
                        @{
                            switch (StepNames[currentStep]) {
                                case DataObjects.StepNameList.SelectPAT:
                                    <div class="mb-3">
                                        <label for="patInput" class="form-label">Personal Access Token (PAT):</label>
                                        <input type="password" disabled="@(_loading)" id="patInput" class="form-control" @bind="DevOpsPAT" @bind:event="oninput" placeholder="Enter your Azure DevOps PAT" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="orgNameInput" class="form-label">Organization Name:</label>
                                        <input type="text" disabled="@(_loading)" id="orgNameInput" class="form-control" @bind="OrgName" @bind:event="oninput" placeholder="Enter your Organization Name" />
                                    </div>
                                    <div class="mb-3">
                                        <p>Or <a href="@Helpers.BuildUrl("login")">Login</a> to use the PAT and Org Information stored in the appsettings.json file.</p>
                                    </div>
                                    break;

                                case DataObjects.StepNameList.SelectProject:
                                    <label class="form-label">Project:</label>
                                    <select class="form-select" @onchange="ProjectChangedWizard" disabled="@_loading">
                                        <option value="">-- Select Project --</option>
                                        @if (DevopsProjectInfos != null) {
                                            @foreach (var proj in DevopsProjectInfos.OrderBy(o => (string.Empty + o.ProjectName).ToLower())) {
                                                <option value="@proj.ProjectId" selected="@(proj.ProjectId == SelectedProjectInfo?.ProjectId ? "selected" : null)">@proj.ProjectName</option>
                                            }
                                        }
                                    </select>
                                    break;

                                case DataObjects.StepNameList.SelectRepository:
                                    <label class="form-label">Repository:</label>
                                    <select class="form-select" @onchange="RepoChangedWizard" disabled="@_loading">
                                        <option value="">-- Select Repository --</option>
                                        @if (SelectedProjectInfo != null) {
                                            @foreach (var repo in SelectedProjectInfo.GitRepos.OrderBy(o => (string.Empty + o.RepoName).ToLower())) {
                                                <option value="@repo.RepoId" selected="@(repo.RepoId == SelectedRepoInfo?.RepoId ? "selected" : null)">@repo.RepoName</option>
                                            }
                                        }
                                    </select>
                                    break;

                                case DataObjects.StepNameList.SelectBranch:
                                    <label class="form-label">Branch:</label>
                                    <select class="form-select" @onchange="BranchChangedWizard" disabled="@_loading">
                                        <option value="">-- Select Branch --</option>
                                        @if (SelectedRepoInfo != null) {
                                            @foreach (var branch in SelectedRepoInfo.GitBranches.OrderBy(o => (string.Empty + o.BranchName).ToLower())) {
                                                <option value="@branch.BranchName" selected="@(branch.BranchName == SelectedBranchInfo?.BranchName ? "selected" : null)">@branch.BranchName</option>
                                            }
                                        }
                                    </select>
                                    break;

                                case DataObjects.StepNameList.SelectCsprojFile:
                                    @if (SelectedBranchInfo == null || SelectedBranchInfo.Files == null || SelectedBranchInfo.Files.Count() == 0) {
                                        <p>No file structure available for the selected branch.</p>
                                    } else {
                                        var csprojFiles = SelectedBranchInfo.Files
                                            .Where(f => f.FileType.EndsWith(".csproj", StringComparison.OrdinalIgnoreCase))
                                            .ToList();
                                        if (csprojFiles.Count == 0) {
                                            <p>No .csproj files found in this branch.</p>
                                        } else {
                                            <label class="form-label">Choose a .csproj file:</label>
                                            <select class="form-select" @onchange="CsProjectFileChangedWizard" disabled="@_loading">
                                                <option value="">-- Select .csproj file --</option>
                                                @foreach (var file in csprojFiles.OrderBy(f => f.Path)) {
                                                    <option value="@file.Path" selected="@(file.Path == SelectedCsprojPath ? "selected" : null)">@file.Path</option>
                                                }
                                            </select>
                                        }
                                    }
                                    break;

                                case DataObjects.StepNameList.EnvironmentSettings:
                                    <p>Select environments to configure (optional):</p>
                                    @foreach (var envKey in GlobalSettings.App.EnvironmentOptions.Keys) {
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input" checked="@(EnvSettings.ContainsKey(envKey))" id="envCheck_@envKey" @onchange="@(e => EnvironmentChangedWizard(envKey, e))" disabled="@_loading" />
                                            <label class="form-check-label" for="envCheck_@envKey">@envKey Environment</label>
                                        </div>
                                        @if (EnvSettings.Keys.Contains(envKey)) {
                                            var envSetting = EnvSettings[envKey];
                                            var _siteOptsList = GetWebsiteOptions(envKey).ToList();
                                            var _vpathOptsList = GetVirtualPathOptions(envKey, envSetting.WebsiteName).ToList();
                                            var _poolOptsList = GetAppPoolOptions(envKey).ToList();

                                            bool _siteLocked = !envSetting.AllowCustomWebsiteName && _siteOptsList.Any() && _siteOptsList.Any(o => string.Equals(envSetting.WebsiteName, o, StringComparison.OrdinalIgnoreCase));
                                            bool _vpathLocked = !envSetting.AllowCustomVirtualPath && _vpathOptsList.Any() && _vpathOptsList.Any(v => string.Equals(envSetting.VirtualPath, v, StringComparison.OrdinalIgnoreCase));
                                            bool _poolLocked = !envSetting.AllowCustomAppPoolName && _poolOptsList.Any() && _poolOptsList.Any(p => string.Equals(envSetting.AppPoolName, p, StringComparison.OrdinalIgnoreCase));

                                            <div class="card bg-light mb-3 ms-4">
                                                <div class="card-body">
                                                    <h6 class="card-title">@envKey Environment Settings</h6>
                                                    <label class="form-label">IIS Deployment Type:</label>
                                                    <select class="form-select" @onchange="@(e => EnvironmentDeploymentTypeChangedWizard(envKey, e))" disabled="@_loading">
                                                        <option value="IISWebsite" selected="@(envSetting.IISDeploymentType == "IISWebsite" ? "selected" : null)">IISWebsite</option>
                                                        <option value="IISWebsiteAuth" selected="@(envSetting.IISDeploymentType == "IISWebsiteAuth" ? "selected" : null)">IISWebsiteAuth</option>
                                                        <option value="IISWebApplication" selected="@(envSetting.IISDeploymentType == "IISWebApplication" ? "selected" : null)">IISWebApplication</option>
                                                        <option value="IISWebApplicationAuth" selected="@(envSetting.IISDeploymentType == "IISWebApplicationAuth" ? "selected" : null)">IISWebApplicationAuth</option>
                                                    </select>

                                                    @if (_siteOptsList.Any()) {
                                                        <label class="form-label mt-2">Website Name (choose from IIS):</label>
                                                        <select class="form-select" @onchange="@(e => EnvironmentWebsiteChangedWizard(envKey, e))" disabled="@_loading">
                                                            <option value="">-- Select Website --</option>
                                                            @foreach (var opt in _siteOptsList) {
                                                                <option value="@opt" selected="@(string.Equals(envSetting.WebsiteName, opt, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@opt</option>
                                                            }
                                                        </select>
                                                    }

                                                    <label class="form-label mt-2">Website Name:</label>
                                                    <input type="text" class="form-control @(_siteLocked ? "bg-light" : null)" @bind="envSetting.WebsiteName" @bind:event="oninput" disabled="@(_loading || _siteLocked)" />

                                                    @if (envSetting.IISDeploymentType == "IISWebApplication" || envSetting.IISDeploymentType == "IISWebApplicationAuth") {
                                                        @if (_vpathOptsList.Any()) {
                                                            <label class="form-label mt-2">Virtual Path (choose from IIS):</label>
                                                            <select class="form-select" @onchange="@(e => EnvironmentVirtualPathChangedWizard(envKey, e))" disabled="@_loading">
                                                                <option value="">-- Select Virtual Path --</option>
                                                                @foreach (var v in _vpathOptsList) {
                                                                    <option value="@v" selected="@(string.Equals(envSetting.VirtualPath, v, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@v</option>
                                                                }
                                                            </select>
                                                        }

                                                        <label class="form-label mt-2">Virtual Path:</label>
                                                        <input type="text" class="form-control @(_vpathLocked ? "bg-light" : null)" @bind="envSetting.VirtualPath" @bind:event="oninput" placeholder="Enter virtual path" disabled="@(_loading || _vpathLocked)" />
                                                    }

                                                    @if (envSetting.IISDeploymentType.Contains("Auth")) {
                                                        <label class="form-label mt-2">Auth User:</label>
                                                        <input type="text" class="form-control" @bind="envSetting.AuthUser" @bind:event="oninput" placeholder="Enter the Auth User" disabled="@_loading" />
                                                    }

                                                    @if (_poolOptsList.Any()) {
                                                        <label class="form-label mt-2">App Pool Name (choose from IIS):</label>
                                                        <select class="form-select" @onchange="@(e => EnvironmentAppPoolChangedWizard(envKey, e))" disabled="@_loading">
                                                            <option value="">-- Select App Pool --</option>
                                                            @foreach (var ap in _poolOptsList) {
                                                                <option value="@ap" selected="@(string.Equals(envSetting.AppPoolName, ap, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@ap</option>
                                                            }
                                                        </select>
                                                    }

                                                    <label class="form-label mt-2">App Pool Name:</label>
                                                    <input type="text" class="form-control @(_poolLocked ? "bg-light" : null)" @bind="envSetting.AppPoolName" @bind:event="oninput" disabled="@(_loading || _poolLocked)" />

                                                    <label class="form-label mt-2">Variable Group Name:</label>
                                                    <input type="text" class="form-control" @bind="envSetting.VariableGroupName" @bind:event="oninput" placeholder="Enter variable group name" disabled="@_loading" />
                                                </div>
                                            </div>
                                        }
                                    }
                                    break;

                                case DataObjects.StepNameList.SelectPipelineSelection:
                                    <label class="form-label">Select Existing Pipeline:</label>
                                    <select class="form-select" @onchange="@(e => PipelineChangedWizard(e))" disabled="@_loading">
                                        <option value="">-- Select Pipeline or Create New --</option>
                                        @foreach (var group in DevopsPipelineDefinitions.GroupBy(p => p.Path).OrderBy(g => g.Key)) {
                                            <optgroup label="@group.Key">
                                                @foreach (var pipe in group.OrderBy(p => p.Name)) {
                                                    <option value="@pipe.Id" selected="@(pipe.Id == SelectedPipelineInfo?.Id ? "selected" : null)">@pipe.Name</option>
                                                }
                                            </optgroup>
                                        }
                                    </select>

                                    @if (SelectedPipelineId <= 0 || SelectedPipelineId == null) {
                                        <div class="mt-3">
                                            <label class="form-label">New Pipeline Name:</label>
                                            <input type="text" class="form-control" @bind="NewPipelineName" @bind:event="oninput" placeholder="Enter pipeline name" />
                                        </div>
                                    } else {
                                        DataObjects.DevopsPipelineDefinition? pipeline = DevopsPipelineDefinitions?.FirstOrDefault(p => p.Id == SelectedPipelineId);
                                        if (pipeline != null) {
                                            <div class="mt-3">
                                                <p><strong>Pipeline Name:</strong> @pipeline.Name</p>
                                                <p><strong>Pipeline Id:</strong> @pipeline.Id</p>
                                                <p><strong>YML File:</strong> @pipeline.YamlFileName</p>
                                            </div>
                                        }
                                    }
                                    break;

                                case DataObjects.StepNameList.YAMLPreviewAndSave:
                                    @if (_isPreviewLoading) {
                                        <div class="alert alert-info d-flex align-items-center" role="alert">
                                            <div class="spinner-border spinner-border-sm me-2" role="status" aria-label="Generating YAML preview">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div>
                                                Generating YAML preview… this can take a little while. Please be patient.
                                            </div>
                                        </div>
                                    }

                                    <div class="mt-3">
                                        <h5>YAML Diff</h5>
                                        @if (_isPreviewLoading) {
                                            <div class="d-flex flex-column justify-content-center align-items-center my-4">
                                                <div class="spinner-border text-primary" role="status" aria-label="Loading YAML Diff">
                                                    <span class="visually-hidden">Loading YAML Diff…</span>
                                                </div>
                                                <div class="mt-3">Preparing YAML preview…</div>
                                            </div>
                                        } else {
                                            @if (string.IsNullOrWhiteSpace(ExistingYamlContent)) {
                                                <p class="text-muted">Nothing to diff.</p>
                                            } else {
                                                <MonacoEditor Id="yaml-diff-editor"
                                                              Language="@MonacoEditor.MonacoLanguage.yaml"
                                                              ReadOnly="true"
                                                              ValueToDiff="@ExistingYamlContent"
                                                              @bind-Value="NewYamlContent" />
                                            }
                                        }
                                    </div>
                                    break;

                                case DataObjects.StepNameList.Completed:
                                    @if (_isSaving)
                                    {
                                        @* Saving state - show spinner and warning *@
                                        <div class="text-center py-5">
                                            <div class="mb-4">
                                                <div class="spinner-border text-warning" style="width: 4rem; height: 4rem;" role="status">
                                                    <span class="visually-hidden">Saving...</span>
                                                </div>
                                            </div>
                                            <h4 class="text-warning">Saving Pipeline Changes</h4>
                                            <p class="text-muted">
                                                Please don't navigate away until this finishes. This may take a moment...
                                            </p>
                                        </div>
                                    }
                                    else if (!string.IsNullOrWhiteSpace(_saveErrorMessage))
                                    {
                                        @* Error state - show error message and retry options *@
                                        <div class="text-center py-4">
                                            <div class="mb-3">
                                                <i class="fa fa-exclamation-circle text-danger" style="font-size: 4rem;"></i>
                                            </div>
                                            <h4 class="text-danger">Failed to Save Pipeline</h4>
                                            <div class="alert alert-danger mt-3 text-start" style="max-width: 600px; margin: 0 auto;">
                                                <strong>Error:</strong> @_saveErrorMessage
                                            </div>
                                            <p class="text-muted mt-3">
                                                You can go back to review your settings and try again, or start over.
                                            </p>
                                        </div>
                                    }
                                    else if (_saveCompleted)
                                    {
                                        @* Success state - show green check and resources *@
                                        <div class="text-center py-4">
                                            <div class="mb-3">
                                                <i class="fa fa-check-circle text-success" style="font-size: 4rem;"></i>
                                            </div>
                                            <h4 class="text-success">Pipeline Created Successfully!</h4>
                                            <p class="lead">
                                                Remember to edit your variable groups before triggering a deployment.
                                            </p>
                                            <div class="mt-4 text-start" style="max-width: 600px; margin: 0 auto;">
                                                <h5>Resources Created / Accessible</h5>
                                                <ul class="list-group list-group-flush">
                                                    @if (LastSavedPipelineDefinition != null && !string.IsNullOrWhiteSpace(LastSavedPipelineDefinition.ResourceUrl))
                                                    {
                                                        <li class="list-group-item">
                                                            <i class="fa fa-code-branch text-success me-2"></i>
                                                            <a target="_blank" href="@LastSavedPipelineDefinition.ResourceUrl">
                                                                <strong>Pipeline:</strong> @LastSavedPipelineDefinition.Name
                                                            </a>
                                                            <i class="fa fa-external-link ms-1 small text-muted"></i>
                                                        </li>
                                                    }

                                                    @if (SelectedProjectInfo != null && !string.IsNullOrWhiteSpace(SelectedProjectInfo.ResourceUrl))
                                                    {
                                                        <li class="list-group-item">
                                                            <i class="fa fa-folder text-primary me-2"></i>
                                                            <a target="_blank" href="@SelectedProjectInfo.ResourceUrl">Project: @SelectedProjectInfo.ProjectName</a>
                                                            <i class="fa fa-external-link ms-1 small text-muted"></i>
                                                        </li>
                                                    }
                                                    @if (SelectedBranchInfo != null && !string.IsNullOrWhiteSpace(SelectedBranchInfo.ResourceUrl))
                                                    {
                                                        <li class="list-group-item">
                                                            <i class="fa fa-code-branch text-primary me-2"></i>
                                                            <a target="_blank" href="@SelectedBranchInfo.ResourceUrl">Branch: @SelectedBranchInfo.BranchName</a>
                                                            <i class="fa fa-external-link ms-1 small text-muted"></i>
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                    }
                                    break;
                            }
                        }

                        @if (_loading) {
                            <div class="d-flex flex-column justify-content-center align-items-center my-5">
                                <div class="spinner-border text-primary" role="status" aria-label="Loading DevOps Info">
                                    <span class="visually-hidden">Loading DevOps Info</span>
                                </div>
                                <div class="mt-3">Loading DevOps Info... please wait, this can take up to a minute.</div>
                            </div>
                        } else if (_loadingMessages.Any()) {
                            <div class="mt-4">
                                <h6 class="text-muted">Update Information</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr class="table-dark">
                                                <th scope="col">Message</th>
                                                <th scope="col">Created</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var message in _loadingMessages) {
                                                <tr>
                                                    <td>@message.Message</td>
                                                    <td>@message.Created</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
}

@code {
    protected async Task MyLoadDataAsync()
    {
        if (Model.LoggedIn) {
            _hidePAT = true;
            currentStep = 1;
            DevOpsPAT = "user is logged in, doesn't matter what this value is";
            OrgName = "user is logged in, this value is ignored, put anything here";
            await PATandOrgNameChangedWizard();
            await PrefetchIISDataIfNeeded();
            StateHasChanged();
        } else {
            OrgName = string.Empty;
            DevOpsPAT = string.Empty;
            currentStep = 0;
            await PrefetchIISDataIfNeeded();
            StateHasChanged();
        }
    }

    private bool _hidePAT = false;
    private int currentStep = 0;
    private string? SelectedProjectId = string.Empty;
    private string? SelectedRepoId = string.Empty;
    private string? SelectedBranch = string.Empty;
    private string? SelectedCsprojPath = string.Empty;
    private string? NewPipelineName = string.Empty;
    private int? SelectedPipelineId = 0;
    private string ExistingYamlContent = string.Empty;
    private string NewYamlContent { get; set; } = string.Empty;
    private DataObjects.BuildDefinition? LastSavedPipelineDefinition { get; set; } = null;
    private string DevOpsPAT { get; set; } = string.Empty;
    private string OrgName { get; set; } = string.Empty;
    private Dictionary<GlobalSettings.EnvironmentType, DataObjects.EnvSetting> EnvSettings = new();

    private string[] StepNames = [
        DataObjects.StepNameList.SelectPAT,
        DataObjects.StepNameList.SelectProject,
        DataObjects.StepNameList.SelectRepository,
        DataObjects.StepNameList.SelectBranch,
        DataObjects.StepNameList.SelectCsprojFile,
        DataObjects.StepNameList.EnvironmentSettings,
        DataObjects.StepNameList.SelectPipelineSelection,
        DataObjects.StepNameList.YAMLPreviewAndSave,
        DataObjects.StepNameList.Completed,
    ];

    private List<DataObjects.DevopsProjectInfo> DevopsProjectInfos { get; set; } = new();
    private List<DataObjects.DevopsVariableGroup> DevopsVariableGroups { get; set; } = new();
    private List<DataObjects.DevopsPipelineDefinition> DevopsPipelineDefinitions { get; set; } = new();
    private List<Guid> _loadingMessagesIds = new List<Guid>();
    private List<LoadingMessage> _loadingMessages = new List<LoadingMessage>();
    private bool _isPreviewLoading = false;
    private bool _isSaving = false;
    private bool _saveCompleted = false;
    private string _saveErrorMessage = string.Empty;

    protected DataObjects.DevopsProjectInfo? SelectedProjectInfo => DevopsProjectInfos?.FirstOrDefault(p => p.ProjectId == SelectedProjectId);
    protected DataObjects.DevopsGitRepoInfo? SelectedRepoInfo => SelectedProjectInfo?.GitRepos.FirstOrDefault(r => r.RepoId == SelectedRepoId);
    protected DataObjects.DevopsGitRepoBranchInfo? SelectedBranchInfo => SelectedRepoInfo?.GitBranches.FirstOrDefault(r => r.BranchName == SelectedBranch);
    protected DataObjects.DevopsPipelineDefinition? SelectedPipelineInfo => DevopsPipelineDefinitions?.FirstOrDefault(p => p.Id == SelectedPipelineId);

    protected DataObjects.DevOpsPipelineRequest? DevOpsPipelineRequest => new DataObjects.DevOpsPipelineRequest {
            Pat = DevOpsPAT,
            OrgName = OrgName,
            ProjectId = SelectedProjectInfo?.ProjectId ?? "",
            RepoId = SelectedRepoInfo?.RepoId ?? "",
            Branch = SelectedBranch ?? "",
            YAMLFileName = SelectedPipelineInfo?.YamlFileName ?? "",
            PipelineId = SelectedPipelineId.GetValueOrDefault(0),
            PipelineName = SelectedPipelineId > 0 ? string.Empty : NewPipelineName ?? "",
            EnvironmentSettings = EnvSettings.ToDictionary(kvp => kvp.Key, kvp => kvp.Value),
            CsProjectFile = SelectedCsprojPath ?? "",
            ConnectionId = Model.SignalrClientRegistration?.ConnectionId
        };

    protected class LoadingMessage
    {
        public DateTime Created { get; set; } = DateTime.Now;
        public string Message { get; set; } = string.Empty;
    }

    private void ClearLoadingMessages()
    {
        _loadingMessagesIds = new List<Guid>();
        _loadingMessages = new List<LoadingMessage>();
        StateHasChanged();
    }

    private async Task NextStep(string? stepName = "")
    {
        ClearLoadingMessages();
        if (currentStep < StepNames.Length - 1) { currentStep++; }

        switch (stepName) {
            case DataObjects.StepNameList.SelectProject:
                StateHasChanged();
                if (!string.IsNullOrWhiteSpace(SelectedProjectId)) {
                    try {
                        List<DataObjects.DevopsPipelineDefinition>? results = await Helpers.GetOrPost<List<DataObjects.DevopsPipelineDefinition>>(DataObjects.Endpoints.DevOps.GetDevOpsPipelines +
                            "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                            "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo?.ProjectId}") +
                            "&orgName=" + Uri.EscapeDataString(OrgName) +
                            "&pat=" + Uri.EscapeDataString(DevOpsPAT));
                        DevopsPipelineDefinitions = results?.ToList() ?? new List<DataObjects.DevopsPipelineDefinition>();
                        if (DevopsPipelineDefinitions != null && DevopsPipelineDefinitions.Count == 1) { SelectedPipelineId = DevopsPipelineDefinitions[0].Id; }
                    } catch { } finally { StateHasChanged(); }
                    await Task.Delay(800);
                }
                break;

            case DataObjects.StepNameList.SelectPipelineSelection:
                _isPreviewLoading = true;
                StateHasChanged();
                if (!string.IsNullOrWhiteSpace(NewPipelineName) || SelectedPipelineId != null) {
                    ExistingYamlContent = string.Empty;
                    var pipeline = DevopsPipelineDefinitions.FirstOrDefault(p => p.Id == SelectedPipelineId);
                    if (pipeline != null && !string.IsNullOrEmpty(pipeline.YamlFileName)) {
                        try {
                            string? results = await Helpers.GetOrPost<string>(DataObjects.Endpoints.DevOps.GetDevOpsYmlFileContent +
                                "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                                "&filePath=" + Uri.EscapeDataString($"{pipeline.YamlFileName}") +
                                "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo?.ProjectId}") +
                                "&repoId=" + Uri.EscapeDataString($"{SelectedRepoInfo?.RepoId}") +
                                "&branchName=" + Uri.EscapeDataString($"{SelectedBranchInfo?.BranchName}") +
                                "&orgName=" + Uri.EscapeDataString(OrgName) +
                                "&pat=" + Uri.EscapeDataString(DevOpsPAT));
                            ExistingYamlContent = results ?? "";
                        } catch { ExistingYamlContent = ""; }
                    } else { SelectedPipelineId = 0; ExistingYamlContent = ""; }
                    NewYamlContent = string.Empty;
                    StateHasChanged();
                    _loadingMessages.Insert(0, new LoadingMessage { Message = "Generating YAML preview…", Created = DateTime.UtcNow });
                    StateHasChanged();
                    try {
                        var response = await Helpers.GetOrPost<string>($"{DataObjects.Endpoints.DevOps.PreviewDevOpsYmlFileContents}", DevOpsPipelineRequest);
                        if (!string.IsNullOrWhiteSpace(response)) { NewYamlContent = response; _loadingMessages.Insert(0, new LoadingMessage { Message = "Preview fetched successfully.", Created = DateTime.UtcNow }); }
                        else { _loadingMessages.Insert(0, new LoadingMessage { Message = $"Error", Created = DateTime.UtcNow }); }
                    } catch (Exception ex) { _loadingMessages.Insert(0, new LoadingMessage { Message = $"Exception: {ex.Message}", Created = DateTime.UtcNow }); }
                    finally { _isPreviewLoading = false; StateHasChanged(); }
                }
                break;

            case DataObjects.StepNameList.YAMLPreviewAndSave:
                // Reset save state
                _isSaving = true;
                _saveCompleted = false;
                _saveErrorMessage = string.Empty;
                LastSavedPipelineDefinition = null;
                StateHasChanged();
                
                try {
                    _loadingMessages.Insert(0, new LoadingMessage { Message = "Saving pipeline… please don't navigate away.", Created = DateTime.UtcNow });
                    StateHasChanged();
                    
                    var createOrUpdateResult = await Helpers.GetOrPost<DataObjects.BuildDefinition>($"{DataObjects.Endpoints.DevOps.CreateOrUpdateDevOpsPipeline}", DevOpsPipelineRequest);
                    
                    if (createOrUpdateResult != null && createOrUpdateResult.Id > 0) {
                        LastSavedPipelineDefinition = createOrUpdateResult;
                        _saveCompleted = true;
                        _loadingMessages.Insert(0, new LoadingMessage { Message = "Pipeline created/updated successfully.", Created = DateTime.UtcNow });
                    } else {
                        _saveErrorMessage = "The server returned an empty or invalid response.";
                        _loadingMessages.Insert(0, new LoadingMessage { Message = $"Error: {_saveErrorMessage}", Created = DateTime.UtcNow });
                    }
                } catch (Exception ex) {
                    _saveErrorMessage = ex.Message;
                    _loadingMessages.Insert(0, new LoadingMessage { Message = $"Exception: {ex.Message}", Created = DateTime.UtcNow });
                }
                finally {
                    _isSaving = false;
                    StateHasChanged();
                }
                break;
        }
    }

    private void PrevStep() { ClearLoadingMessages(); if (currentStep > 0) { currentStep--; StateHasChanged(); } }

    private async Task PATandOrgNameChangedWizard()
    {
        ClearLoadingMessages();
        StateHasChanged();
        try {
            List<DataObjects.DevopsProjectInfo>? result = await Helpers.GetOrPost<List<DataObjects.DevopsProjectInfo>>(DataObjects.Endpoints.DevOps.GetDevOpsProjects +
                "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                "&orgName=" + Uri.EscapeDataString(OrgName) +
                "&pat=" + Uri.EscapeDataString(DevOpsPAT));
            if (result != null && result.Any()) {
                DevopsProjectInfos = result.ToList();
                currentStep = 1;
                StateHasChanged();
                if (DevopsProjectInfos.Count == 1) { SelectedProjectId = DevopsProjectInfos[0].ProjectId; await ProjectChangedWizard(new ChangeEventArgs { Value = SelectedProjectId }); }
            } else { DevopsProjectInfos = new List<DataObjects.DevopsProjectInfo>(); }
        } catch { } finally { await Task.CompletedTask; StateHasChanged(); }
    }

    private async Task ProjectChangedWizard(ChangeEventArgs e)
    {
        ClearLoadingMessages();
        StateHasChanged();
        try {
            SelectedProjectId = e.Value?.ToString() ?? "";
            SelectedRepoId = "";
            SelectedBranch = "";
            if (SelectedProjectInfo != null) {
                List<DataObjects.DevopsGitRepoInfo>? result = await Helpers.GetOrPost<List<DataObjects.DevopsGitRepoInfo>>(DataObjects.Endpoints.DevOps.GetDevOpsRepos +
                    "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                    "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo.ProjectId}") +
                    "&orgName=" + Uri.EscapeDataString(OrgName) +
                    "&pat=" + Uri.EscapeDataString(DevOpsPAT));
                if (result != null && result.Any()) {
                    if (DevopsProjectInfos != null) { foreach (var item in DevopsProjectInfos) { if (item.ProjectId == SelectedProjectId) { item.GitRepos = result; } else { item.GitRepos = new List<DataObjects.DevopsGitRepoInfo>(); } } }
                    if (result.Count == 1) { SelectedRepoId = result[0].RepoId; await RepoChangedWizard(new ChangeEventArgs { Value = SelectedRepoId }); }
                }
            }
        } catch { } finally { await Task.CompletedTask; StateHasChanged(); }
    }

    private async Task RepoChangedWizard(ChangeEventArgs e)
    {
        ClearLoadingMessages();
        StateHasChanged();
        try {
            SelectedRepoId = e.Value?.ToString() ?? "";
            SelectedBranch = "";
            if (SelectedRepoInfo != null) {
                List<DataObjects.DevopsGitRepoBranchInfo>? result = await Helpers.GetOrPost<List<DataObjects.DevopsGitRepoBranchInfo>>(DataObjects.Endpoints.DevOps.GetDevOpsBranches +
                    "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                    "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo?.ProjectId}") +
                    "&repoId=" + Uri.EscapeDataString($"{SelectedRepoInfo?.RepoId}") +
                    "&orgName=" + Uri.EscapeDataString(OrgName) +
                    "&pat=" + Uri.EscapeDataString(DevOpsPAT));
                if (result != null && result.Any()) {
                    if (DevopsProjectInfos != null) { foreach (var project in DevopsProjectInfos) { if (project.ProjectId == SelectedProjectId) { foreach (var repo in project.GitRepos) { if (repo.RepoId == SelectedRepoInfo?.RepoId) { repo.GitBranches = result; } else { repo.GitBranches = new List<DataObjects.DevopsGitRepoBranchInfo>(); } } } } }
                    if (result.Count == 1) { SelectedBranch = result[0].BranchName; await BranchChangedWizard(new ChangeEventArgs { Value = SelectedBranch }); }
                }
            }
        } catch { } finally { await Task.CompletedTask; StateHasChanged(); }
    }

    private async Task BranchChangedWizard(ChangeEventArgs e)
    {
        ClearLoadingMessages();
        StateHasChanged();
        try {
            SelectedBranch = e.Value?.ToString() ?? "";
            if (SelectedBranchInfo != null) {
                List<DataObjects.DevopsFileItem>? result = await Helpers.GetOrPost<List<DataObjects.DevopsFileItem>>(DataObjects.Endpoints.DevOps.GetDevOpsFiles +
                    "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                    "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo?.ProjectId}") +
                    "&repoId=" + Uri.EscapeDataString($"{SelectedRepoInfo?.RepoId}") +
                    "&branchName=" + Uri.EscapeDataString($"{SelectedBranchInfo?.BranchName}") +
                    "&orgName=" + Uri.EscapeDataString(OrgName) +
                    "&pat=" + Uri.EscapeDataString(DevOpsPAT));
                if (result != null && result.Any()) {
                    if (DevopsProjectInfos != null) { foreach (var project in DevopsProjectInfos) { if (project.ProjectId == SelectedProjectId) { foreach (var repo in project.GitRepos) { if (repo.RepoId == SelectedRepoInfo?.RepoId) { foreach (var branch in repo.GitBranches) { if (branch.BranchName == SelectedBranchInfo?.BranchName) { branch.Files = result.ToList(); } else { branch.Files = new List<DataObjects.DevopsFileItem>(); } } } } } } }
                    var csprojFiles = result.Where(f => f.FileType.EndsWith(".csproj", StringComparison.OrdinalIgnoreCase)).ToList();
                    if (csprojFiles.Count == 1) { SelectedCsprojPath = csprojFiles[0].Path; }
                }
            }
        } catch { } finally { await Task.CompletedTask; StateHasChanged(); }
    }

    private async Task CsProjectFileChangedWizard(ChangeEventArgs e) { ClearLoadingMessages(); StateHasChanged(); try { SelectedCsprojPath = e?.Value?.ToString() ?? ""; } catch { } finally { await Task.CompletedTask; StateHasChanged(); } }

    private async Task EnvironmentChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e)
    {
        ClearLoadingMessages();
        StateHasChanged();
        try {
            bool isChecked = e.Value != null && bool.TryParse(e.Value.ToString(), out bool result) && result;
            if (isChecked) {
                string websiteNameDefault = GlobalSettings.App.EnvironmentOptions[envKey]?.Hostname ?? string.Empty;
                EnvSettings[envKey] = new DataObjects.EnvSetting {
                    EnvName = envKey, IISDeploymentType = "IISWebApplication", WebsiteName = "" + websiteNameDefault,
                    VirtualPath = "/" + SelectedProjectInfo?.ProjectName?.ToLower(),
                    AppPoolName = "" + websiteNameDefault + "." + SelectedProjectInfo?.ProjectName?.ToLower(),
                    VariableGroupName = $"{SelectedProjectInfo?.ProjectName}_{GlobalSettings.App.VariableGroupNameDefault}_{envKey}"
                };
            } else { if (EnvSettings.ContainsKey(envKey)) { EnvSettings.Remove(envKey); } }
        } catch { } finally { await Task.CompletedTask; StateHasChanged(); }
    }

    private async Task EnvironmentDeploymentTypeChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e)
    {
        ClearLoadingMessages();
        StateHasChanged();
        try {
            string deploymentType = e.Value?.ToString() ?? "";
            if (EnvSettings.ContainsKey(envKey)) {
                EnvSettings[envKey].IISDeploymentType = deploymentType;
                EnvSettings[envKey].VirtualPath = (deploymentType == "IISWebApplication" || deploymentType == "IISWebApplicationAuth") ? "/" + SelectedProjectInfo?.ProjectName?.ToLower() : "";
            }
        } catch { } finally { await Task.CompletedTask; StateHasChanged(); }
    }

    private async Task PipelineChangedWizard(ChangeEventArgs e) { try { ExistingYamlContent = string.Empty; NewYamlContent = string.Empty; SelectedPipelineId = 0; if (int.TryParse(e.Value?.ToString(), out int pid)) { SelectedPipelineId = pid; } } catch { } finally { await Task.CompletedTask; StateHasChanged(); } }

    private bool _iisPrefetched = false;
    private Dictionary<GlobalSettings.EnvironmentType, DataObjects.IISInfo> _iisData = new();

    private static bool TryMapEnvKeyToEnum(string key, out GlobalSettings.EnvironmentType env)
    {
        env = default;
        if (string.IsNullOrWhiteSpace(key)) return false;
        var k = key.Trim();
        if (Enum.TryParse<GlobalSettings.EnvironmentType>(k, true, out env)) return true;
        if (k.Contains("dev", StringComparison.OrdinalIgnoreCase)) { env = GlobalSettings.EnvironmentType.DEV; return true; }
        if (k.Contains("prod", StringComparison.OrdinalIgnoreCase)) { env = GlobalSettings.EnvironmentType.PROD; return true; }
        if (k.Contains("cms", StringComparison.OrdinalIgnoreCase)) { env = GlobalSettings.EnvironmentType.CMS; return true; }
        return false;
    }

    private async Task PrefetchIISDataIfNeeded()
    {
        if (_iisPrefetched) { await Task.CompletedTask; return; }
        try {
            var apiResult = await Helpers.GetOrPost<Dictionary<string, DataObjects.IISInfo>>(DataObjects.Endpoints.DevOps.GetDevOpsIISInfo);
            _iisData.Clear();
            if (apiResult != null) { foreach (var kv in apiResult) { if (TryMapEnvKeyToEnum(kv.Key, out var envKey) && kv.Value != null) { _iisData[envKey] = kv.Value; } } }
        } catch { _iisData.Clear(); }
        _iisPrefetched = true;
        await Task.CompletedTask;
    }

    private IEnumerable<string> GetWebsiteOptions(GlobalSettings.EnvironmentType envKey) { if (_iisData.TryGetValue(envKey, out var info) && info?.Sites != null) { return info.Sites.Select(s => s?.Name ?? string.Empty).Where(n => !string.IsNullOrWhiteSpace(n)).Distinct(StringComparer.OrdinalIgnoreCase).OrderBy(n => n, StringComparer.OrdinalIgnoreCase); } return Array.Empty<string>(); }

    private IEnumerable<string> GetVirtualPathOptions(GlobalSettings.EnvironmentType envKey, string websiteName) { if (_iisData.TryGetValue(envKey, out var info) && info?.Sites != null && !string.IsNullOrWhiteSpace(websiteName)) { var site = info.Sites.FirstOrDefault(s => string.Equals(s?.Name ?? string.Empty, websiteName, StringComparison.OrdinalIgnoreCase)); if (site?.Applications != null) { return site.Applications.Select(a => a?.Path ?? string.Empty).Where(p => !string.IsNullOrWhiteSpace(p)).Distinct(StringComparer.OrdinalIgnoreCase).OrderBy(p => p, StringComparer.OrdinalIgnoreCase); } } return Array.Empty<string>(); }

    private IEnumerable<string> GetAppPoolOptions(GlobalSettings.EnvironmentType envKey) { if (_iisData.TryGetValue(envKey, out var info) && info != null) { var fromPools = (info.ApplicationPools ?? new List<DataObjects.ApplicationPool>()).Select(ap => ap?.Name ?? string.Empty).Where(n => !string.IsNullOrWhiteSpace(n)); var fromApps = (info.Sites ?? new List<DataObjects.Site>()).Where(s => s?.Applications != null).SelectMany(s => s.Applications).Select(a => a?.AppPool ?? string.Empty).Where(n => !string.IsNullOrWhiteSpace(n)); return fromPools.Concat(fromApps).Distinct(StringComparer.OrdinalIgnoreCase).OrderBy(n => n, StringComparer.OrdinalIgnoreCase); } return Array.Empty<string>(); }

    private async Task EnvironmentWebsiteChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e) { try { var value = e?.Value?.ToString() ?? ""; if (EnvSettings.ContainsKey(envKey)) { EnvSettings[envKey].WebsiteName = value; EnvSettings[envKey].AllowCustomWebsiteName = string.IsNullOrWhiteSpace(value); } } catch { } finally { await Task.CompletedTask; StateHasChanged(); } }

    private async Task EnvironmentVirtualPathChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e) { try { var value = e?.Value?.ToString() ?? ""; if (EnvSettings.ContainsKey(envKey)) { EnvSettings[envKey].VirtualPath = value; EnvSettings[envKey].AllowCustomVirtualPath = string.IsNullOrWhiteSpace(value); } } catch { } finally { await Task.CompletedTask; StateHasChanged(); } }

    private async Task EnvironmentAppPoolChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e) { try { var value = e?.Value?.ToString() ?? ""; if (EnvSettings.ContainsKey(envKey)) { EnvSettings[envKey].AppPoolName = value; EnvSettings[envKey].AllowCustomAppPoolName = string.IsNullOrWhiteSpace(value); } } catch { } finally { await Task.CompletedTask; StateHasChanged(); } }

    /// <summary>
    /// Resets the wizard to its initial state, clearing all selections and returning to step 0 (or step 1 if logged in).
    /// </summary>
    private void StartOver()
    {
        ClearLoadingMessages();
        
        // Reset all selections
        SelectedProjectId = string.Empty;
        SelectedRepoId = string.Empty;
        SelectedBranch = string.Empty;
        SelectedCsprojPath = string.Empty;
        SelectedPipelineId = 0;
        NewPipelineName = string.Empty;
        ExistingYamlContent = string.Empty;
        NewYamlContent = string.Empty;
        LastSavedPipelineDefinition = null;
        EnvSettings.Clear();
        
        // Reset save state
        _isSaving = false;
        _saveCompleted = false;
        _saveErrorMessage = string.Empty;
        
        // Reset to appropriate starting step
        if (Model.LoggedIn)
        {
            currentStep = 1; // Skip PAT step for logged-in users
        }
        else
        {
            currentStep = 0;
            DevOpsPAT = string.Empty;
            OrgName = string.Empty;
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Navigate to a specific step (only allows going back to previously completed steps).
    /// </summary>
    private async Task GoToStep(int stepIndex)
    {
        if (stepIndex < currentStep && stepIndex >= (_hidePAT ? 1 : 0))
        {
            ClearLoadingMessages();
            currentStep = stepIndex;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    /// <summary>
    /// Gets the wizard step information for the WizardStepper component.
    /// </summary>
    private List<WizardStepper.WizardStepInfo> GetWizardSteps()
    {
        var steps = new List<WizardStepper.WizardStepInfo>();
        
        for (int i = _hidePAT ? 1 : 0; i < StepNames.Length; i++)
        {
            var stepName = StepNames[i];
            var shortName = GetShortStepName(stepName);
            var selectedValue = GetStepSelectedValue(i);
            
            steps.Add(new WizardStepper.WizardStepInfo
            {
                Name = stepName,
                ShortName = shortName,
                SelectedValue = selectedValue
            });
        }
        
        return steps;
    }

    private string GetShortStepName(string stepName)
    {
        return stepName switch
        {
            DataObjects.StepNameList.SelectPAT => "Credentials",
            DataObjects.StepNameList.SelectProject => "Project",
            DataObjects.StepNameList.SelectRepository => "Repository",
            DataObjects.StepNameList.SelectBranch => "Branch",
            DataObjects.StepNameList.SelectCsprojFile => ".csproj",
            DataObjects.StepNameList.EnvironmentSettings => "Environments",
            DataObjects.StepNameList.SelectPipelineSelection => "Pipeline",
            DataObjects.StepNameList.YAMLPreviewAndSave => "Preview",
            DataObjects.StepNameList.Completed => "Done",
            _ => stepName
        };
    }

    private string GetStepSelectedValue(int stepIndex)
    {
        var stepName = StepNames[stepIndex];
        return stepName switch
        {
            DataObjects.StepNameList.SelectPAT => !string.IsNullOrWhiteSpace(OrgName) ? OrgName : "",
            DataObjects.StepNameList.SelectProject => SelectedProjectInfo?.ProjectName ?? "",
            DataObjects.StepNameList.SelectRepository => SelectedRepoInfo?.RepoName ?? "",
            DataObjects.StepNameList.SelectBranch => SelectedBranchInfo?.BranchName ?? "",
            DataObjects.StepNameList.SelectCsprojFile => !string.IsNullOrWhiteSpace(SelectedCsprojPath) ? System.IO.Path.GetFileName(SelectedCsprojPath) : "",
            DataObjects.StepNameList.EnvironmentSettings => EnvSettings.Any() ? string.Join(", ", EnvSettings.Keys.Select(k => k.ToString())) : "",
            DataObjects.StepNameList.SelectPipelineSelection => SelectedPipelineInfo?.Name ?? NewPipelineName ?? "",
            DataObjects.StepNameList.YAMLPreviewAndSave => !string.IsNullOrWhiteSpace(NewYamlContent) ? "Ready" : "",
            DataObjects.StepNameList.Completed => "?",
            _ => ""
        };
    }

    /// <summary>
    /// Gets the selection summary items for the SelectionSummary component.
    /// </summary>
    private List<SelectionSummary.SelectionItem> GetSelectionSummary()
    {
        var selections = new List<SelectionSummary.SelectionItem>();
        
        if (!string.IsNullOrWhiteSpace(SelectedProjectInfo?.ProjectName))
        {
            selections.Add(new SelectionSummary.SelectionItem { Label = "Project", Value = SelectedProjectInfo.ProjectName });
        }
        
        if (!string.IsNullOrWhiteSpace(SelectedRepoInfo?.RepoName))
        {
            selections.Add(new SelectionSummary.SelectionItem { Label = "Repository", Value = SelectedRepoInfo.RepoName });
        }
        
        if (!string.IsNullOrWhiteSpace(SelectedBranchInfo?.BranchName))
        {
            selections.Add(new SelectionSummary.SelectionItem { Label = "Branch", Value = SelectedBranchInfo.BranchName });
        }
        
        if (!string.IsNullOrWhiteSpace(SelectedCsprojPath))
        {
            selections.Add(new SelectionSummary.SelectionItem { Label = ".csproj File", Value = SelectedCsprojPath });
        }
        
        if (EnvSettings.Any())
        {
            selections.Add(new SelectionSummary.SelectionItem { Label = "Environments", Value = string.Join(", ", EnvSettings.Keys.Select(k => k.ToString())) });
        }
        
        if (SelectedPipelineInfo != null)
        {
            selections.Add(new SelectionSummary.SelectionItem { Label = "Pipeline", Value = SelectedPipelineInfo.Name ?? "" });
        }
        else if (!string.IsNullOrWhiteSpace(NewPipelineName))
        {
            selections.Add(new SelectionSummary.SelectionItem { Label = "New Pipeline", Value = NewPipelineName });
        }
        
        return selections;
    }

    /// <summary>
    /// Gets the current step index adjusted for the WizardStepper (accounts for hidden PAT step).
    /// </summary>
    private int GetAdjustedCurrentStep()
    {
        return _hidePAT ? currentStep - 1 : currentStep;
    }
}
