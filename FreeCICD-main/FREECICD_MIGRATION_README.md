# FreeCICD Migration Guide
## From Old (.NET 9) to New (.NET 10) Base Framework

---

## Table of Contents
1. [Overview](#overview)
2. [Base Framework Features (Shared Between Both Versions)](#base-framework-features)
3. [FreeCICD-Specific Features (To Be Migrated)](#freecicd-specific-features)
4. [Architecture & Workflow Diagrams](#architecture--workflow-diagrams)
5. [Migration Phases](#migration-phases)
6. [Detailed File Creation Plan](#detailed-file-creation-plan)
7. [API Endpoint Reference](#api-endpoint-reference)

---

## Overview

The FreeCRM framework provides a complete Blazor WebAssembly application template that can be customized for different purposes. The **FreeCICD** application extends this base to create a CI/CD pipeline management tool for Azure DevOps.

### Project Structure

```
FreeCICD_Latest/
??? New/                           # .NET 10 Base Framework (Target)
?   ??? FreeCICD/                  # Server-side Blazor host
?   ??? FreeCICD.Client/           # Blazor WebAssembly client
?   ??? FreeCICD.DataAccess/       # Data access layer
?   ??? FreeCICD.DataObjects/      # Shared data models
?   ??? FreeCICD.EFModels/         # Entity Framework models
?   ??? FreeCICD.Plugins/          # Plugin system
?
??? Old/                           # .NET 9 Completed FreeCICD (Source)
    ??? FreeCICD/                  # Server-side with CI/CD features
    ??? FreeCICD.Client/           # Client with pipeline wizard
    ??? FreeCICD.DataAccess/       # Azure DevOps integration
    ??? FreeCICD.DataObjects/      # CI/CD data models
    ??? FreeCICD.EFModels/         # Database models
    ??? FreeCICD.Plugins/          # Plugin system
```

---

## Base Framework Features

These features are **identical** in both Old and New versions and do NOT need migration:

### Authentication & Authorization
- Custom authentication handler with JWT support
- Social login providers (Google, Facebook, Microsoft, Apple, OpenID)
- Role-based access control
- Multi-tenant support

### User Management
- User CRUD operations
- User groups and permissions
- Department management
- Department groups

### Core Infrastructure
- Entity Framework Core (SQL Server, MySQL, PostgreSQL, SQLite, InMemory)
- SignalR real-time communication hub
- File storage system
- Tag management system
- Settings and configuration management
- Language/internationalization support
- UDF (User Defined Fields) system
- Plugin architecture with C# code compilation

### UI Components
- Login/Logout pages
- Profile management
- Password change
- Admin settings pages
- Tenant management
- Deleted records management

### Common API Endpoints (Already in Base)
- `/api/Data/Authenticate`
- `/api/Data/Users/*`
- `/api/Data/Departments/*`
- `/api/Data/UserGroups/*`
- `/api/Data/Tags/*`
- `/api/Data/FileStorage/*`
- `/api/Data/Settings/*`
- `/api/Data/Language/*`
- `/api/Data/Encryption/*`
- `/api/Data/Plugins/*`
- `/api/Data/Tenants/*`
- `/api/Data/Ajax/*`

---

## FreeCICD-Specific Features

These features are **custom to FreeCICD** and need to be migrated:

### 1. Azure DevOps Integration
- Connect to Azure DevOps organizations via PAT (Personal Access Token)
- Browse projects, repositories, branches
- List and view files in repositories
- Create and manage build pipelines
- Manage variable groups
- Generate YAML pipeline files

### 2. IIS Configuration Support
- Read IIS server information from JSON files
- Populate website names, virtual paths, and app pool names
- Support for multiple environments (DEV, PROD, CMS)

### 3. Pipeline Wizard UI
- Multi-step wizard for pipeline creation
- PAT/Organization selection (for anonymous users)
- Project selection with async loading
- Repository and branch selection
- .csproj file selection from repo
- Environment configuration (DEV/PROD/CMS)
- YAML preview with Monaco diff editor
- Save and create pipeline

### 4. Custom Data Objects
- `DevopsProjectInfo` - Azure DevOps project metadata
- `DevopsGitRepoInfo` - Repository information
- `DevopsGitRepoBranchInfo` - Branch details with files
- `DevopsFileItem` - File in repository
- `DevopsPipelineDefinition` - Build pipeline definition
- `DevopsVariableGroup` / `DevopsVariable` - Variable groups
- `DevOpsPipelineRequest` - Pipeline creation request
- `EnvSetting` - Environment configuration
- `IISInfo` / `Site` / `Application` / `ApplicationPool` / `Binding` - IIS metadata
- `BuildDefinition` - Created pipeline result
- `GitUpdateResult` - Git operation result

### 5. Global Settings
- `EnvironmentType` enum (DEV, PROD, CMS)
- `EnvironmentOptions` with agent pools and hostnames
- `BuildPiplelinePool` setting
- `BuildPipelineTemplate` YAML template
- `AzureDevOpsProjectNameStartsWithIgnoreValues` - Filter ignored projects

---

## Architecture & Workflow Diagrams

### Application Layer Architecture

```
???????????????????????????????????????????????????????????????????????????????
?                           BLAZOR WEBASSEMBLY CLIENT                         ?
?  ???????????????????  ??????????????????????  ????????????????????????????  ?
?  ?   Index.App     ?  ?   BlazorDataModel  ?  ?      Helpers.App         ?  ?
?  ? (Pipeline       ?  ?   .App.cs          ?  ?   (API Calls, Icons,     ?  ?
?  ?  Wizard UI)     ?  ?  (State Mgmt)      ?  ?    SignalR Processing)   ?  ?
?  ???????????????????  ??????????????????????  ????????????????????????????  ?
?           ?                     ?                          ?                ?
?           ??????????????????????????????????????????????????                ?
?                                 ?                                           ?
?                                 ?                                           ?
?                    ??????????????????????????                               ?
?                    ?   HTTP / SignalR       ?                               ?
???????????????????????????????????????????????????????????????????????????????
                                  ?
                                  ?
???????????????????????????????????????????????????????????????????????????????
?                              ASP.NET CORE SERVER                            ?
?  ??????????????????????????  ??????????????????????????  ?????????????????  ?
?  ? DataController.App     ?  ? ConfigurationHelper    ?  ?  SignalR Hub  ?  ?
?  ? .FreeCICD.cs           ?  ? .App.FreeCICD.cs       ?  ?               ?  ?
?  ? (API Endpoints)        ?  ? (PAT, OrgName, etc.)   ?  ?               ?  ?
?  ??????????????????????????  ??????????????????????????  ?????????????????  ?
?              ?                           ?                                  ?
?              ?????????????????????????????                                  ?
?                           ?                                                 ?
?                           ?                                                 ?
?              ??????????????????????????                                     ?
?              ?    IDataAccess (DI)    ?                                     ?
???????????????????????????????????????????????????????????????????????????????
                            ?
                            ?
???????????????????????????????????????????????????????????????????????????????
?                            DATA ACCESS LAYER                                ?
?  ???????????????????????????????????????????????????????????????????????    ?
?  ?                   DataAccess.App.FreeCICD.cs                        ?    ?
?  ?  ????????????????????  ??????????????????????  ???????????????????  ?    ?
?  ?  ? Azure DevOps API ?  ? Pipeline Generator ?  ? Git Operations  ?  ?    ?
?  ?  ?  - Projects      ?  ?  - YAML Template   ?  ?  - Create File  ?  ?    ?
?  ?  ?  - Repos         ?  ?  - Variables       ?  ?  - Update File  ?  ?    ?
?  ?  ?  - Branches      ?  ?  - Deploy Stages   ?  ?  - Get Content  ?  ?    ?
?  ?  ?  - Files         ?  ?                    ?  ?                 ?  ?    ?
?  ?  ?  - Pipelines     ?  ?                    ?  ?                 ?  ?    ?
?  ?  ?  - Var Groups    ?  ?                    ?  ?                 ?  ?    ?
?  ?  ????????????????????  ??????????????????????  ???????????????????  ?    ?
?  ???????????????????????????????????????????????????????????????????????    ?
???????????????????????????????????????????????????????????????????????????????
```

### Pipeline Wizard Flow

```
????????????????????????????????????????????????????????????????????????????????
?                         PIPELINE CREATION WIZARD                             ?
????????????????????????????????????????????????????????????????????????????????

   ???????????????      ???????????????      ???????????????      ???????????????
   ?   Step 0    ?      ?   Step 1    ?      ?   Step 2    ?      ?   Step 3    ?
   ?  PAT Entry  ????????   Select    ????????   Select    ????????   Select    ?
   ? (Anonymous) ?      ?   Project   ?      ? Repository  ?      ?   Branch    ?
   ?             ?      ?             ?      ?             ?      ?             ?
   ???????????????      ???????????????      ???????????????      ???????????????
         ?                    ?                    ?                    ?
         ?                    ?                    ?                    ?
   ???????????????      ???????????????      ???????????????      ???????????????
   ? Input PAT   ?      ? API Call:   ?      ? API Call:   ?      ? API Call:   ?
   ? & OrgName   ?      ?GetDevOps    ?      ?GetDevOps    ?      ?GetDevOps    ?
   ?             ?      ?Projects     ?      ?Repos        ?      ?Branches     ?
   ???????????????      ???????????????      ???????????????      ???????????????


   ???????????????      ???????????????      ???????????????      ???????????????
   ?   Step 4    ?      ?   Step 5    ?      ?   Step 6    ?      ?   Step 7    ?
   ?  Select     ????????Environment  ????????  Pipeline   ????????   YAML      ?
   ?  .csproj    ?      ?  Settings   ?      ?  Selection  ?      ?  Preview    ?
   ?             ?      ?             ?      ?             ?      ?             ?
   ???????????????      ???????????????      ???????????????      ???????????????
         ?                    ?                    ?                    ?
         ?                    ?                    ?                    ?
   ???????????????      ???????????????      ???????????????      ???????????????
   ? API Call:   ?      ? Configure:  ?      ? API Call:   ?      ? API Call:   ?
   ?GetDevOps    ?      ? DEV/PROD/   ?      ?GetDevOps    ?      ?Preview      ?
   ?Files        ?      ? CMS envs    ?      ?Pipelines    ?      ?YmlContents  ?
   ???????????????      ???????????????      ???????????????      ???????????????


                              ???????????????
                              ?   Step 8    ?
                              ?  Completed  ?
                              ?             ?
                              ???????????????
                                    ?
                                    ?
                              ???????????????
                              ? API Call:   ?
                              ?CreateOrUpdate?
                              ?DevOpsPipeline?
                              ???????????????
```

### Azure DevOps API Integration Flow

```
???????????????????????????????????????????????????????????????????????????????
?                        AZURE DEVOPS API INTEGRATION                         ?
???????????????????????????????????????????????????????????????????????????????

  FreeCICD Server                           Azure DevOps
       ?                                         ?
       ?  ?????????????????????????????????????? ?
       ?  ? VssConnection (PAT Authentication) ? ?
       ?  ?????????????????????????????????????? ?
       ?                    ?                    ?
       ???????????????????????????????????????????
       ?                    ?                    ?
       ?  ProjectHttpClient ?                    ?
       ? ????????????????????   /projects        ?
       ?                    ??????????????????????
       ?                    ?                    ?
       ?  GitHttpClient     ?                    ?
       ? ????????????????????   /git/repos       ?
       ?                    ??????????????????????
       ?                    ?                    ?
       ? ????????????????????   /git/branches    ?
       ?                    ??????????????????????
       ?                    ?                    ?
       ? ????????????????????   /git/items       ?
       ?                    ??????????????????????
       ?                    ?                    ?
       ? ????????????????????   /git/pushes      ?
       ?                    ??????????????????????
       ?                    ?                    ?
       ?  BuildHttpClient   ?                    ?
       ? ????????????????????   /build/defs      ?
       ?                    ??????????????????????
       ?                    ?                    ?
       ?  TaskAgentClient   ?                    ?
       ? ????????????????????   /distributedtask ?
       ?                    ?????????????????????? /variablegroups
       ?                    ?                    ?
       ???????????????????????????????????????????
```

### SignalR Real-Time Updates

```
???????????????????????????????????????????????????????????????????????????????
?                         SIGNALR UPDATE FLOW                                 ?
???????????????????????????????????????????????????????????????????????????????

    Client                    Server                      Azure DevOps
      ?                         ?                              ?
      ?   SignalR Connect       ?                              ?
      ? ?????????????????????????                              ?
      ?   (ConnectionId)        ?                              ?
      ?                         ?                              ?
      ?   API Request           ?                              ?
      ?   (with ConnectionId)   ?                              ?
      ? ?????????????????????????   API Calls                  ?
      ?                         ????????????????????????????????
      ?                         ?                              ?
      ?                         ??? For each result            ?
      ?   SignalR Push          ?                              ?
      ?   "LoadingDevOps        ?                              ?
      ?    InfoStatusUpdate"    ?                              ?
      ???????????????????????????                              ?
      ?   (Progress Message)    ?                              ?
      ?                         ?                              ?
      ?   Update UI             ?                              ?
      ?   (Show message)        ?                              ?
      ?                         ?                              ?
      ?   HTTP Response         ?                              ?
      ???????????????????????????                              ?
      ?   (Final Data)          ?                              ?
      ?                         ?                              ?
      ?   Update UI             ?                              ?
      ?   (Render results)      ?                              ?
      ?                         ?                              ?
      ??????????????????????????????????????????????????????????
```

---

## Migration Phases

### Phase 1: Infrastructure Setup
**Goal:** Add Azure DevOps SDK dependencies and configuration support

| Step | Action | Files |
|------|--------|-------|
| 1.1 | Add NuGet packages to DataAccess | `New\FreeCICD.DataAccess\FreeCICD.DataAccess.csproj` |
| 1.2 | Add configuration properties | `New\FreeCICD\Classes\ConfigurationHelper.App.FreeCICD.cs` (new) |
| 1.3 | Update appsettings schema | `New\FreeCICD\appsettings.json` |
| 1.4 | Load config in Program.cs | `New\FreeCICD\Program.App.FreeCICD.cs` (new) |

### Phase 2: Data Objects
**Goal:** Create all FreeCICD-specific data models

| Step | Action | Files |
|------|--------|-------|
| 2.1 | Create DevOps data objects | `New\FreeCICD.DataObjects\DataObjects.App.FreeCICD.cs` (new) |
| 2.2 | Create GlobalSettings | `New\FreeCICD.DataObjects\GlobalSettings.App.FreeCICD.cs` (new) |
| 2.3 | Add SignalR update types | `New\FreeCICD.DataObjects\DataObjects.App.FreeCICD.cs` |

### Phase 3: Data Access Layer
**Goal:** Implement Azure DevOps integration

| Step | Action | Files |
|------|--------|-------|
| 3.1 | Create interface extensions | `New\FreeCICD.DataAccess\DataAccess.App.FreeCICD.cs` (new) |
| 3.2 | Implement Azure DevOps clients | `New\FreeCICD.DataAccess\DataAccess.App.FreeCICD.cs` |
| 3.3 | Implement pipeline operations | `New\FreeCICD.DataAccess\DataAccess.App.FreeCICD.cs` |
| 3.4 | Implement Git operations | `New\FreeCICD.DataAccess\DataAccess.App.FreeCICD.cs` |
| 3.5 | Implement IIS info provider | `New\FreeCICD.DataAccess\DataAccess.App.FreeCICD.cs` |

### Phase 4: API Controllers
**Goal:** Create REST API endpoints

| Step | Action | Files |
|------|--------|-------|
| 4.1 | Create DevOps endpoints | `New\FreeCICD\Controllers\DataController.App.FreeCICD.cs` (new) |
| 4.2 | Wire up endpoints | Add route handling |

### Phase 5: Client UI
**Goal:** Implement the pipeline wizard

| Step | Action | Files |
|------|--------|-------|
| 5.1 | Update Helpers.App | `New\FreeCICD.Client\Helpers.App.FreeCICD.cs` (new) |
| 5.2 | Update DataModel.App | `New\FreeCICD.Client\DataModel.App.FreeCICD.cs` (new) |
| 5.3 | Create Index.App wizard | `New\FreeCICD.Client\Shared\AppComponents\Index.App.FreeCICD.razor` (new) |
| 5.4 | Wire Index.App.razor | Include FreeCICD component |

### Phase 6: Testing & Validation
**Goal:** Verify migration completeness

| Step | Action | Files |
|------|--------|-------|
| 6.1 | Build solution | Verify compilation |
| 6.2 | Test wizard flow | Verify UI functionality |
| 6.3 | Test Azure DevOps API | Verify API connectivity |

---

## Detailed File Creation Plan

### Files to Create (New `*.App.FreeCICD.*` Pattern)

| File Path | Source File | Description |
|-----------|-------------|-------------|
| `New\FreeCICD\Classes\ConfigurationHelper.App.FreeCICD.cs` | `Old\FreeCICD\Classes\ConfigurationHelper.App.FreeCICD.cs` | Azure DevOps PAT, OrgName, ProjectId, RepoId, Branch config properties |
| `New\FreeCICD\Program.App.FreeCICD.cs` | (inline in Old) | Load Azure DevOps config from appsettings.json |
| `New\FreeCICD\Controllers\DataController.App.FreeCICD.cs` | `Old\FreeCICD\Controllers\DataController.App.FreeCICD.cs` | All DevOps API endpoints (~12 endpoints) |
| `New\FreeCICD.DataAccess\DataAccess.App.FreeCICD.cs` | `Old\FreeCICD.DataAccess\DataAccess.App.FreeCICD.cs` | Full Azure DevOps integration (~800 lines) |
| `New\FreeCICD.DataObjects\DataObjects.App.FreeCICD.cs` | `Old\FreeCICD.DataObjects\DataObjects.App.FreeCICD.cs` | All DevOps data objects (~30 classes) |
| `New\FreeCICD.DataObjects\GlobalSettings.App.FreeCICD.cs` | `Old\FreeCICD.DataObjects\GlobalSettings.App.cs` | Environment types, options, YAML template |
| `New\FreeCICD.Client\Helpers.App.FreeCICD.cs` | (subset of Old helpers) | DevOps-specific helper methods |
| `New\FreeCICD.Client\DataModel.App.FreeCICD.cs` | (new) | DevOps state management extensions |
| `New\FreeCICD.Client\Shared\AppComponents\Index.App.FreeCICD.razor` | `Old\FreeCICD.Client\Shared\AppComponents\Index.App.razor` | Pipeline wizard UI (~700 lines) |

### Files to Modify (Minimal Changes to Hook Into FreeCICD)

| File Path | Change | Description |
|-----------|--------|-------------|
| `New\FreeCICD.DataAccess\FreeCICD.DataAccess.csproj` | Add packages | Azure DevOps SDK NuGet packages |
| `New\FreeCICD\appsettings.json` | Add section | `App.Azure*` configuration |
| `New\FreeCICD\Classes\ConfigurationHelper.App.cs` | Add call | Reference FreeCICD properties |
| `New\FreeCICD\Program.App.cs` | Add call | Load FreeCICD config |
| `New\FreeCICD\Controllers\DataController.App.cs` | Add call | Wire SignalR updates |
| `New\FreeCICD.DataAccess\DataAccess.App.cs` | Add call | Wire DataAccess extensions |
| `New\FreeCICD.DataObjects\DataObjects.App.cs` | Add partial | Extend SignalRUpdate |
| `New\FreeCICD.DataObjects\GlobalSettings.App.cs` | Add partial | Reference App class |
| `New\FreeCICD.Client\Helpers.App.cs` | Add call | Reference FreeCICD helpers |
| `New\FreeCICD.Client\DataModel.App.cs` | Add properties | Reference FreeCICD state |
| `New\FreeCICD.Client\Shared\AppComponents\Index.App.razor` | Include | Render FreeCICD wizard |

---

## API Endpoint Reference

### FreeCICD-Specific Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `api/Data/GetDevOpsProjects` | GET | List all projects in Azure DevOps org |
| `api/Data/GetDevOpsRepos` | GET | List repos in a project |
| `api/Data/GetDevOpsBranches` | GET | List branches in a repo |
| `api/Data/GetDevOpsFiles` | GET | List files in a branch |
| `api/Data/GetDevOpsPipelines` | GET | List build pipelines |
| `api/Data/GetDevOpsYmlFileContent` | GET | Get YAML file content |
| `api/Data/GetDevOpsIISInfo` | GET | Get IIS server info |
| `api/Data/PreviewDevOpsYmlFileContents` | POST | Generate YAML preview |
| `api/Data/CreateOrUpdateDevOpsPipeline` | POST | Create/update pipeline |

### Query Parameters

| Parameter | Used By | Description |
|-----------|---------|-------------|
| `pat` | All | Personal Access Token (if not logged in) |
| `orgName` | All | Azure DevOps organization name |
| `projectId` | Most | Project GUID |
| `repoId` | File/Branch | Repository GUID |
| `branchName` | File | Branch name |
| `connectionId` | All | SignalR connection for progress updates |

---

## Migration Checklist

- [ ] Phase 1: Infrastructure Setup
  - [ ] Add NuGet packages
  - [ ] Create ConfigurationHelper.App.FreeCICD.cs
  - [ ] Update appsettings.json
  - [ ] Create/update Program.App.FreeCICD.cs
  
- [ ] Phase 2: Data Objects
  - [ ] Create DataObjects.App.FreeCICD.cs
  - [ ] Create GlobalSettings.App.FreeCICD.cs
  
- [ ] Phase 3: Data Access Layer
  - [ ] Create DataAccess.App.FreeCICD.cs
  
- [ ] Phase 4: API Controllers
  - [ ] Create DataController.App.FreeCICD.cs
  
- [ ] Phase 5: Client UI
  - [ ] Create Index.App.FreeCICD.razor
  - [ ] Create Helpers.App.FreeCICD.cs (if needed)
  - [ ] Create DataModel.App.FreeCICD.cs (if needed)
  - [ ] Update Index.App.razor to include FreeCICD
  
- [ ] Phase 6: Testing
  - [ ] Build succeeds
  - [ ] Wizard loads
  - [ ] API calls work
  - [ ] Pipeline creation works

---

## Notes

### File Naming Convention
Following the established pattern:
- **Base files:** `FileName.cs`, `FileName.App.cs`, `FileName.App.razor`
- **FreeCICD extensions:** `FileName.App.FreeCICD.cs`, `FileName.App.FreeCICD.razor`

This allows:
1. Clear separation between base framework and custom code
2. Easy identification of what needs to change per application
3. Minimal merge conflicts when base framework updates

### SignalR Update Types
The FreeCICD adds one custom SignalR update type:
- `LoadingDevOpsInfoStatusUpdate` - Progress messages during Azure DevOps API operations

This is added to the `SignalRUpdateType` enum in the base DataObjects.

### Environment Configuration
FreeCICD uses a 3-environment model by default:
- **DEV** - Development environment
- **PROD** - Production environment  
- **CMS** - Content Management System environment

Each environment maps to an Azure DevOps agent pool and IIS server configuration.
